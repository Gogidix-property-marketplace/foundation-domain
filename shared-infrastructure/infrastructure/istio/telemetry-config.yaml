# Istio Telemetry Configuration
# Configures distributed tracing, metrics, and logging

---
# Enable Telemetry v2 API
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: istio-control-plane
  namespace: istio-system
spec:
  components:
    pilot:
      k8s:
        env:
        - name: PILOT_ENABLE_WORKLOAD_ENTRY_AUTHORIZATION
          value: "true"
        - name: PILOT_ENABLE_IAUTHZ_POLICY
          value: "true"
        - name: PILOT_TRACE_SAMPLING
          value: "100"
    telemetry:
      enabled: true

---
# Telemetry API Configuration
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: default
  namespace: istio-system
spec:
  # No selector - applies to all workloads
  accessLogging:
  - providers:
    - name: envoy
    file:
      path: /dev/stdout
      format: |
        {
          "start_time": "%START_TIME%",
          "method": "%REQ(:METHOD)%",
          "x-envoy-origin-path": "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%",
          "protocol": "%PROTOCOL%",
          "response_code": "%RESPONSE_CODE%",
          "response_flags": "%RESPONSE_FLAGS%",
          "response_code_details": "%RESPONSE_CODE_DETAILS%",
          "connection_termination_details": "%CONNECTION_TERMINATION_DETAILS%",
          "upstream_transport_failure_reason": "%UPSTREAM_TRANSPORT_FAILURE_REASON%",
          "bytes_received": "%BYTES_RECEIVED%",
          "bytes_sent": "%BYTES_SENT%",
          "duration": "%DURATION%",
          "x-envoy-upstream-service-time": "%REQ(X-ENVOY-UPSTREAM-SERVICE-TIME)%",
          "x-forwarded-for": "%REQ(X-FORWARDED-FOR)%",
          "user-agent": "%REQ(USER-AGENT)%",
          "x-request-id": "%REQ(X-REQUEST-ID)%",
          "x-b3-traceid": "%REQ(X-B3-TRACEID)%",
          "x-b3-spanid": "%REQ(X-B3-SPANID)%",
          "x-b3-parentspanid": "%REQ(X-B3-PARENTSPANID)%",
          "x-b3-sampled": "%REQ(X-B3-SAMPLED)%",
          "x-b3-flags": "%REQ(X-B3-FLAGS)%",
          "x-b3-ot-span-context": "%REQ(X-B3-OT-SPAN-CONTEXT)%"
        }

  # Metrics configuration
  metrics:
  - providers:
    - name: prometheus
    overrides:
    - match:
        metric: ALL_METRICS
      tagOverrides:
        destination_service:
          operation: REMOVE
        grpc_request_message_count:
          operation: REMOVE
        grpc_response_message_count:
          operation: REMOVE

  # Tracing configuration
  tracing:
  - providers:
    - name: jaeger
    sampling: 100
    customTags:
      app.tag_name:
        literal:
          value: "gogidix-property-marketplace"
      version.tag_name:
        literal:
          value: "v1.0.0"
      environment.tag_name:
        literal:
          value: "production"
      cluster.tag_name:
        literal:
          value: "gogidix-cluster"

---
# Envoy Proxy Telemetry Configuration
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: default-workload
  namespace: gogidix-workloads
spec:
  selector:
    matchLabels:
      # Apply to all workloads in the namespace
  accessLogging:
  - providers:
    - name: envoy
      file:
        path: /dev/stdout
        jsonFormat:
          timestamp: "%START_TIME%"
          level: "info"
          trace_id: "%REQ(X-REQUEST-ID)%"
          span_id: "%REQ(X-B3-SPANID)%"
          trace_sampled: "%REQ(X-B3-SAMPLED)%"
          connection_id: "%CONNECTION_ID%"
          upstream_host: "%UPSTREAM_HOST%"
          upstream_cluster: "%UPSTREAM_CLUSTER%"
          upstream_local_address: "%UPSTREAM_LOCAL_ADDRESS%"
          downstream_local_address: "%DOWNSTREAM_LOCAL_ADDRESS%"
          downstream_remote_address: "%DOWNSTREAM_REMOTE_ADDRESS%"
          requested_server_name: "%REQUESTED_SERVER_NAME%"
          route_name: "%ROUTE_NAME%"
          listener_name: "%LISTENER_NAME%"
          user_agent: "%REQ(USER-AGENT)%"
          request_id: "%REQ(X-REQUEST-ID)%"
          x_forwarded_for: "%REQ(X-FORWARDED-FOR)%"
          x_b3_traceid: "%REQ(X-B3-TRACEID)%"
          x_b3_spanid: "%REQ(X-B3-SPANID)%"
          x_b3_parentspanid: "%REQ(X-B3-PARENTSPANID)%"
          x_b3_sampled: "%REQ(X-B3-SAMPLED)%"
          b3: "%REQ(X-B3-TRACEID)%,%REQ(X-B3-SPANID)%,%REQ(X-B3-PARENTSPANID)%,%REQ(X-B3-SAMPLED)%,%REQ(X-B3-FLAGS)%"
          authority: "%REQ(:AUTHORITY)%"
          host: "%REQ(HOST)%"
          method: "%REQ(:METHOD)%"
          path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
          protocol: "%PROTOCOL%"
          response_code: "%RESPONSE_CODE%"
          response_flags: "%RESPONSE_FLAGS%"
          response_code_details: "%RESPONSE_CODE_DETAILS%"
          bytes_received: "%BYTES_RECEIVED%"
          bytes_sent: "%BYTES_SENT%"
          duration: "%DURATION%"
          x_envoy_upstream_service_time: "%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%"

  metrics:
  - providers:
    - name: prometheus
    overrides:
    - match:
        metric: ALL_METRICS
      tagOverrides:
        destination_service:
          operation: REMOVE
        grpc_request_message_count:
          operation: REMOVE
        grpc_response_message_count:
          operation: REMOVE
        # Add custom tags
        service_tag:
          value: "gogidix-property-marketplace"
        team_tag:
          value: "infrastructure"

---
# ServiceMonitor for Prometheus
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: istio-proxy
  namespace: istio-system
  labels:
    app: istio-proxy
    release: prometheus
spec:
  selector:
    matchLabels:
      app: istio-proxy
  namespaceSelector:
    any: true
  endpoints:
  - port: http-monitoring
    interval: 15s
    path: /stats/prometheus
    honorLabels: true

---
# PrometheusRule for Istio Alerting
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: istio-rules
  namespace: istio-system
  labels:
    app: istio
spec:
  groups:
  - name: istio.rules
    rules:
    - alert: IstioHighErrorRate
      expr: |
        sum(
          rate(
            istio_requests_total{
              response_code!~"5..",
              reporter="destination"
            }[5m]
          )
        ) /
        sum(
          rate(
            istio_requests_total{
              reporter="destination"
            }[5m]
          )
        ) > 0.05
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: High error rate detected
        description: "{{ $value }}% error rate detected in service mesh"

    - alert: IstioHighLatency
      expr: |
        histogram_quantile(
          0.95,
          sum(
            rate(
              istio_request_duration_milliseconds_bucket{
                reporter="destination"
              }[5m]
            )
          ) by (le, destination_service)
        ) > 5000
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: High latency detected
        description: "95th percentile latency is {{ $value }}ms"

    - alert: IstioCircuitBreakerOpen
      expr: |
        istio_circuit_breaker_open > 0
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: Circuit breaker is open
        description: "Circuit breaker is open for destination: {{ $labels.destination_service }}"

    - alert: IstioUpstreamConnectionFailure
      expr: |
        sum(
          rate(
            istio_requests_total{
              response_code=="503",
              reporter="destination"
            }[5m]
          )
        ) > 0.1
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: Upstream connection failures
        description: "High rate of upstream connection failures: {{ $value }} req/s"

---
# Grafana Dashboard ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: istio-dashboard
  namespace: istio-system
  labels:
    grafana_dashboard: "1"
data:
  istio-mesh-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Istio Mesh Dashboard",
        "tags": ["istio"],
        "timezone": "browser",
        "panels": [
          {
            "title": "Request Rate",
            "type": "graph",
            "targets": [
              {
                "expr": "sum(rate(istio_requests_total{reporter=\"destination\"}[5m])) by (source_workload, destination_workload)",
                "legendFormat": "{{source_workload}} -> {{destination_workload}}"
              }
            ]
          },
          {
            "title": "Success Rate",
            "type": "singlestat",
            "targets": [
              {
                "expr": "sum(rate(istio_requests_total{reporter=\"destination\",response_code!~\"5..\"}[5m])) / sum(rate(istio_requests_total{reporter=\"destination\"}[5m])) * 100"
              }
            ]
          },
          {
            "title": "Request Duration",
            "type": "graph",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, sum(rate(istio_request_duration_milliseconds_bucket{reporter=\"destination\"}[5m])) by (le, destination_workload))",
                "legendFormat": "95th percentile - {{destination_workload}}"
              }
            ]
          },
          {
            "title": "Active Services",
            "type": "stat",
            "targets": [
              {
                "expr": "count(istio_requests_total{reporter=\"destination\"})",
                "legendFormat": "Active Services"
              }
            ]
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "30s"
      }
    }