# GitHub Actions CI/CD Pipeline for Gogidix Property Marketplace
# Automated build, test, and deployment workflow

name: Build and Deploy

on:
  push:
    branches: [ main, develop, 'feature/*' ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Code Quality and Security Scanning
  code-quality:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Run Checkstyle
      run: mvn checkstyle:check

    - name: Run PMD Analysis
      run: mvn pmd:check

    - name: Run SpotBugs Analysis
      run: mvn spotbugs:check

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    - name: OWASP Dependency Check
      run: mvn org.owasp:dependency-check-maven:check

  # Build and Test
  build-and-test:
    runs-on: ubuntu-latest
    needs: code-quality
    strategy:
      matrix:
        service: [api-gateway, rate-limiting-service, property-service, user-service, payment-service, circuit-breaker-service]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Build service
      run: |
        cd Gogidix-Domain/foundation-domain/shared-infrastructure/java-services/${{ matrix.service }}
        mvn clean compile -DskipTests

    - name: Run unit tests
      run: |
        cd Gogidix-Domain/foundation-domain/shared-infrastructure/java-services/${{ matrix.service }}
        mvn test

    - name: Generate Test Report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Test Results - ${{ matrix.service }}
        path: Gogidix-Domain/foundation-domain/shared-infrastructure/java-services/${{ matrix.service }}/target/surefire-reports/*.xml
        reporter: java-junit

    - name: Run integration tests
      run: |
        cd Gogidix-Domain/foundation-domain/shared-infrastructure/java-services/${{ matrix.service }}
        mvn verify -Pintegration-tests

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: Gogidix-Domain/foundation-domain/shared-infrastructure/java-services/${{ matrix.service }}
        push: false
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.service }}:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.service }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.service }}:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # Security Testing
  security-testing:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install security tools
      run: |
        pip install safety bandit semgrep

    - name: Run Bandit Security Analysis
      run: |
        find . -name "*.py" -exec bandit -r {} +

    - name: Run Semgrep Static Analysis
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/owasp-top-ten

    - name: OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.10.0
      with:
        target: 'https://api-staging.gogidix.com'

  # Deploy to Staging
  deploy-staging:
    runs-on: ubuntu-latest
    needs: [build-and-test, security-testing]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Update kubeconfig
      run: aws eks update-kubeconfig --name gogidix-eks

    - name: Deploy to staging
      run: |
        # Deploy API Gateway
        kubectl set image deployment/api-gateway api-gateway=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api-gateway:${{ github.sha }} -n api-gateway
        kubectl rollout status deployment/api-gateway -n api-gateway

        # Deploy other services
        for service in rate-limiting-service property-service user-service payment-service circuit-breaker-service; do
          kubectl set image deployment/${service} ${service}=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${service}:${{ github.sha }} -n gogidix-workloads
          kubectl rollout status deployment/${service} -n gogidix-workloads
        done

    - name: Run smoke tests
      run: |
        # Install k6 for load testing
        curl https://github.com/grafana/k6/releases/download/v0.45.0/k6-v0.45.0-linux-amd64.tar.gz | tar xz
        sudo mv k6-v0.45.0-linux-amd64/k6 /usr/local/bin/

        # Run smoke tests
        k6 run --env API_URL=https://api-staging.gogidix.com tests/smoke-test.js

    - name: Run load tests
      run: |
        k6 run --env API_URL=https://api-staging.gogidix.com tests/load-test.js

  # Deploy to Production
  deploy-production:
    runs-on: ubuntu-latest
    needs: [build-and-test, security-testing]
    if: github.event_name == 'release'
    environment: production
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_PROD_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_PROD_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Update kubeconfig
      run: aws eks update-kubeconfig --name gogidix-eks-prod

    - name: Create backup before deployment
      run: |
        # Create database backup
        aws rds create-db-cluster-snapshot \
          --db-cluster-identifier gogidix-aurora \
          --db-cluster-snapshot-identifier pre-deploy-$(date +%Y%m%d-%H%M%S)

    - name: Deploy to production (Canary)
      run: |
        # Start with 10% canary deployment
        kubectl patch deployment api-gateway -p '{"spec":{"template":{"spec":{"containers":[{"name":"api-gateway","image":"${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api-gateway:${{ github.sha }}"}]}}}}' -n api-gateway

        # Wait for rollout
        kubectl rollout status deployment/api-gateway -n api-gateway --timeout=600s

        # Monitor for issues
        sleep 300  # 5 minutes monitoring period

        # If no issues, scale up to 100%
        kubectl scale deployment api-gateway --replicas=5 -n api-gateway

    - name: Full production rollout
      run: |
        # Deploy remaining services
        for service in rate-limiting-service property-service user-service payment-service circuit-breaker-service; do
          kubectl set image deployment/${service} ${service}=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${service}:${{ github.sha }} -n gogidix-workloads
          kubectl rollout status deployment/${service} -n gogidix-workloads --timeout=600s
        done

    - name: Post-deployment validation
      run: |
        # Health check all services
        for service in api-gateway property-service user-service payment-service; do
          kubectl wait --for=condition=ready pod -l app=${service} --timeout=300s
        done

        # Run end-to-end tests
        npm ci
        npm run test:e2e

    - name: Send deployment notification
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        text: "Production deployment completed successfully! ðŸš€"

  # Rollback if needed
  rollback:
    runs-on: ubuntu-latest
    needs: deploy-production
    if: failure() && github.event_name == 'release'
    environment: production
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_PROD_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_PROD_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Update kubeconfig
      run: aws eks update-kubeconfig --name gogidix-eks-prod

    - name: Rollback deployment
      run: |
        # Rollback to previous version
        kubectl rollout undo deployment/api-gateway -n api-gateway
        kubectl rollout status deployment/api-gateway -n api-gateway

        for service in rate-limiting-service property-service user-service payment-service circuit-breaker-service; do
          kubectl rollout undo deployment/${service} -n gogidix-workloads
          kubectl rollout status deployment/${service} -n gogidix-workloads
        done

    - name: Send rollback notification
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: failure
        channel: '#alerts'
        text: "Production deployment failed, rollback initiated! ðŸš¨"

  # Performance Testing
  performance-test:
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/develop'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install k6
      run: |
        curl https://github.com/grafana/k6/releases/download/v0.45.0/k6-v0.45.0-linux-amd64.tar.gz | tar xz
        sudo mv k6-v0.45.0-linux-amd64/k6 /usr/local/bin/

    - name: Install Gatling
      run: |
        wget https://bintray.com/gatling/gatling/3.9.5/gatling-charts-highcharts-3.9.5.zip
        unzip gatling-charts-highcharts-3.9.5.zip
        sudo mv gatling/bin/gatling /usr/local/bin/

    - name: Run Performance Tests
      run: |
        # k6 performance test
        k6 run --env API_URL=https://api-staging.gogidix.com tests/performance/k6-load-test.js

        # Gatling performance test
        cd tests/performance/gatling
        gatling -s gatling.simulations.ApiPerformanceTest

    - name: Upload performance results
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: |
          k6-results/
          gatling-reports/

  # Update Documentation
  update-docs:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [build-and-test, deploy-staging]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate API documentation
      run: |
        # Generate OpenAPI specs
        docker run --rm -v $(pwd):/app \
          swaggerapi/swagger-codegen-cli generate \
          -i /app/api-gateway/src/main/resources/api.yaml \
          -l html \
          -o /app/docs/api

    - name: Deploy to documentation site
      run: |
        # Deploy to GitHub Pages or Confluence
        git config --global user.name "CI/CD Bot"
        git config --global user.email "ci-cd@gogidix.com"
        git add docs/
        git commit -m "Update documentation"
        git push