# Prometheus High Availability Cluster Deployment
# Enterprise monitoring for Gogidix Property Marketplace

---
# Prometheus Operator
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: prometheus
  namespace: monitoring
spec:
  channel: beta
  name: prometheus
  source: community-operators
  sourceNamespace: openshift-marketplace
  startingCSV: prometheusoperator.0.56.3

---
# Monitoring Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
  labels:
    name: monitoring
    istio-injection: enabled

---
# Prometheus CRD
apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: prometheus-gogidix
  namespace: monitoring
  labels:
    app: prometheus
    tier: monitoring
spec:
  serviceAccountName: prometheus
  serviceMonitorSelector:
    matchLabels:
      team: gogidix
  ruleSelector:
    matchLabels:
      team: gogidix

  # High Availability Configuration
  replicas: 3
  replicaExternalLabelName: "replica"

  # Resources Configuration
  resources:
    requests:
      cpu: 2000m
      memory: 20Gi
    limits:
      cpu: 4000m
      memory: 40Gi

  # Storage Configuration
  storage:
    volumeClaimTemplate:
      spec:
        storageClassName: fast-ssd
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 200Gi

  # Retention Configuration
  retention: 30d
  retentionSize: 100GB

  # Remote Write Configuration
  remoteWrite:
  - url: "https://prometheus-remote.gogidix.com/api/v1/write"
    queueConfig:
      maxSamplesPerSend: 10000
      maxShards: 200
      capacity: 25000
    writeRelabelConfigs:
    - sourceLabels: [__name__]
      regex: 'istio_.*|envoy_.*'
      targetLabel: cluster
      replacement: 'gogidix-prod'

  # Additional Scrape Configs
  additionalScrapeConfigs:
  - job_name: 'kubernetes-apiservers'
    kubernetes_sd_configs:
    - role: endpoints
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    relabel_configs:
    - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
      action: keep
      regex: default;kubernetes;https

  - job_name: 'kubernetes-nodes'
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - action: labelmap
      regex: __meta_kubernetes_node_label_(.+)
    - target_label: __address__
      replacement: kubernetes.default.svc:443
    - source_labels: [__meta_kubernetes_node_name]
      regex: (.+)
      target_label: __metrics_path__
      replacement: /api/v1/nodes/${1}/proxy/metrics

  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
    - role: pod
    relabel_configs:
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
      action: keep
      regex: true
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
      action: replace
      target_label: __metrics_path__
      regex: (.+)
    - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
      action: replace
      regex: ([^:]+)(?::\d+)?;(\d+)
      replacement: $1:$2
      target_label: __address__
    - action: labelmap
      regex: __meta_kubernetes_pod_label_(.+)
    - source_labels: [__meta_kubernetes_namespace]
      action: replace
      target_label: kubernetes_namespace
    - source_labels: [__meta_kubernetes_pod_name]
      action: replace
      target_label: kubernetes_pod_name
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scheme]
      action: replace
      target_label: __scheme__
      regex: (https?)
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_tls_config]
      action: keep
      regex: true

---
# Alertmanager Configuration
apiVersion: monitoring.coreos.com/v1
kind: Alertmanager
metadata:
  name: alertmanager-gogidix
  namespace: monitoring
spec:
  replicas: 3
  serviceAccountName: alertmanager
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 2Gi

  # Storage
  storage:
    volumeClaimTemplate:
      spec:
        storageClassName: fast-ssd
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 20Gi

  # Alertmanager Configuration
  alertmanagerConfigSelector:
    matchLabels:
      team: gogidix

---
# AlertmanagerConfig
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: gogidix-alerts
  namespace: monitoring
  labels:
    team: gogidix
spec:
  # Route Configuration
  route:
    group_by: ['alertname', 'cluster', 'service']
    group_wait: 10s
    group_interval: 10s
    repeat_interval: 12h
    receiver: 'default'
    routes:
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      repeat_interval: 5m
    - match:
        severity: warning
      receiver: 'warning-alerts'
      repeat_interval: 2h
    - match:
        alertname: 'Watchdog'
      receiver: 'null'

  # Receivers
  receivers:
  - name: 'default'
    slack_configs:
    - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
      channel: '#alerts'
      title: 'Gogidix Alert'
      text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
      send_resolved: true
      actions:
        - type: button
          text: 'Runbook :gear:'
          url: '{{ .Annotations.runbook_url }}'
        - type: button
          text: 'Dashboard :chart_with_upwards_trend:'
          url: '{{ .Annotations.dashboard_url }}'

  - name: 'critical-alerts'
    slack_configs:
    - api_url: 'https://hooks.slack.com/services/YOUR/CRITICAL/WEBHOOK'
      channel: '#critical-alerts'
      color: 'danger'
      title: ':rotating_light: CRITICAL ALERT :rotating_light:'
      text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
      send_resolved: true
    email_configs:
    - to: 'oncall@gogidix.com'
      from: 'prometheus@gogidix.com'
      smarthost: 'smtp.gogidix.com:587'
      auth_username: 'prometheus@gogidix.com'
      auth_password: 'password'
      require_tls: true
      subject: '[CRITICAL] {{ .GroupLabels.alertname }}'
      body: |
        {{ range .Alerts }}
        Alert: {{ .Annotations.summary }}
        Description: {{ .Annotations.description }}
        Runbook: {{ .Annotations.runbook_url }}
        {{ end }}

  - name: 'warning-alerts'
    slack_configs:
    - api_url: 'https://hooks.slack.com/services/YOUR/WARNING/WEBHOOK'
      channel: '#alerts'
      color: 'warning'
      title: '⚠️ WARNING ALERT ⚠️'
      text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
      send_resolved: true

  - name: 'null'

---
# PrometheusRule for Gogidix Services
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: gogidix-services
  namespace: monitoring
  labels:
    team: gogidix
spec:
  groups:
  - name: api-gateway.rules
    rules:
    - alert: APIGatewayHighErrorRate
      expr: |
        sum(
          rate(
            http_requests_total{
              job="api-gateway",
              status_code=~"5.."
            }[5m]
          )
        ) /
        sum(
          rate(
            http_requests_total{
              job="api-gateway"
            }[5m]
          )
        ) > 0.05
      for: 2m
      labels:
        severity: critical
        service: api-gateway
      annotations:
        summary: "High error rate in API Gateway"
        description: "Error rate is {{ $value | humanizePercentage }} (>5%)"
        dashboard_url: "http://grafana.gogidix.com/d/api-gateway"
        runbook_url: "https://wiki.gogidix.com/runbooks/api-gateway"

    - alert: APIGatewayHighLatency
      expr: |
        histogram_quantile(
          0.95,
          sum(
            rate(
              http_request_duration_seconds_bucket{
                job="api-gateway"
              }[5m]
          )) by (le)
        ) > 1
      for: 5m
      labels:
        severity: warning
        service: api-gateway
      annotations:
        summary: "High latency in API Gateway"
        description: "95th percentile latency is {{ $value }}s (>1s)"

  - name: property-service.rules
    rules:
    - alert: PropertyServiceDown
      expr: up{job="property-service"} == 0
      for: 1m
      labels:
        severity: critical
        service: property-service
      annotations:
        summary: "Property Service is down"
        description: "Property Service has been down for more than 1 minute"
        runbook_url: "https://wiki.gogidix.com/runbooks/property-service"

    - alert: PropertyServiceHighMemoryUsage
      expr: |
        process_resident_memory_bytes{
          job="property-service"
        } / 1024 / 1024 / 1024 > 4
      for: 10m
      labels:
        severity: warning
        service: property-service
      annotations:
        summary: "High memory usage in Property Service"
        description: "Memory usage is {{ $value }}GB (>4GB)"

  - name: database.rules
    rules:
    - alert: DatabaseConnectionsHigh
      expr: |
        pg_stat_activity_count{
          datname="gogidix_property"
        } > 80
      for: 5m
      labels:
        severity: warning
        service: postgresql
      annotations:
        summary: "High number of database connections"
        description: "{{ $value }} active connections (>80)"

    - alert: DatabaseReplicationLag
      expr: |
        pg_replication_lag_seconds > 60
      for: 2m
      labels:
        severity: critical
        service: postgresql
      annotations:
        summary: "Database replication lag"
        description: "Replication lag is {{ $value }}s (>60s)"

  - name: infrastructure.rules
    rules:
    - alert: NodeDiskUsageHigh
      expr: |
        100 - (
          (
            node_filesystem_avail_bytes{
              device!="/dev/ram0",
              fstype!~"tmpfs|overlay"
            } /
            node_filesystem_size_bytes{
              device!="/dev/ram0",
              fstype!~"tmpfs|overlay"
            }
          ) * 100
        ) > 85
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Disk usage high on {{ $labels.instance }}"
        description: "Disk usage is {{ $value }}% (>85%)"

    - alert: PodCrashLooping
      expr: |
        rate(
          kube_pod_container_status_restarts_total[15m]
        ) > 0
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping"
        description: "Pod has restarted {{ $value }} times in the last 15 minutes"

---
# ServiceMonitor for API Gateway
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: api-gateway
  namespace: api-gateway
  labels:
    team: gogidix
spec:
  selector:
    matchLabels:
      app: api-gateway
  endpoints:
  - port: http
    path: /actuator/prometheus
    interval: 15s
    scrapeTimeout: 10s
    metricRelabelings:
    - sourceLabels: [__name__]
      regex: 'http_server_requests_seconds_(.+)'
      targetLabel: http_server_requests
      replacement: '${1}'

---
# ServiceMonitor for Property Service
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: property-service
  namespace: property-service
  labels:
    team: gogidix
spec:
  selector:
    matchLabels:
      app: property-service
  endpoints:
  - port: http
    path: /actuator/prometheus
    interval: 15s
    scrapeTimeout: 10s

---
# ServiceMonitor for User Service
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: user-service
  namespace: user-service
  labels:
    team: gogidix
spec:
  selector:
    matchLabels:
      app: user-service
  endpoints:
  - port: http
    path: /actuator/prometheus
    interval: 15s
    scrapeTimeout: 10s

---
# ServiceMonitor for Payment Service
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: payment-service
  namespace: payment-service
  labels:
    team: gogidix
spec:
  selector:
    matchLabels:
      app: payment-service
  endpoints:
  - port: http
    path: /actuator/prometheus
    interval: 10s
    scrapeTimeout: 5s

---
# ServiceMonitor for PostgreSQL
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: postgres-exporter
  namespace: monitoring
  labels:
    team: gogidix
spec:
  selector:
    matchLabels:
      app: postgres-exporter
  endpoints:
  - port: metrics
    interval: 30s
    scrapeTimeout: 10s

---
# ServiceMonitor for Redis
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: redis-exporter
  namespace: monitoring
  labels:
    team: gogidix
spec:
  selector:
    matchLabels:
      app: redis-exporter
  endpoints:
  - port: metrics
    interval: 30s
    scrapeTimeout: 10s

---
# ServiceMonitor for Istio
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: istio-proxy
  namespace: istio-system
  labels:
    team: gogidix
spec:
  selector:
    matchLabels:
      app: istio-proxy
  namespaceSelector:
    any: true
  endpoints:
  - port: http-monitoring
    interval: 15s
    path: /stats/prometheus

---
# ServiceMonitor for Kubelet
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: kubelet
  namespace: monitoring
  labels:
    team: gogidix
spec:
  selector:
    matchLabels:
      k8s-app: kubelet
  namespaceSelector:
    matchNames:
    - kube-system
  endpoints:
  - port: https-metrics
    scheme: https
    tlsConfig:
      insecureSkipVerify: true
    bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    interval: 30s