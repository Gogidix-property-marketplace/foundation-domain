# ✨ GOGIDIX PLATFORM - INGRESS CONFIGURATION ✨
# Enterprise ingress with SSL, rate limiting, and path routing

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: gogidix-ingress
  namespace: gogidix-prod
  annotations:
    # NGINX Ingress Controller
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/rewrite-target: /$2

    # SSL Configuration
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # Rate Limiting
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"

    # CORS Configuration
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://app.gogidix.com,https://admin.gogidix.com"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"

    # Large Request Support
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"

    # WebSocket Support
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"

    # Custom Error Pages
    nginx.ingress.kubernetes.io/custom-http-errors: "404,503"

    # Backend Protocol
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"

    # Connection Limits
    nginx.ingress.kubernetes.io/connection-proxy-header: "keep-alive"

    # Sticky Sessions (if needed)
    # nginx.ingress.kubernetes.io/affinity: "cookie"
    # nginx.ingress.kubernetes.io/session-cookie-name: "gogidix-route"
    # nginx.ingress.kubernetes.io/session-cookie-hash: "sha1"

    # IP Whitelist (for admin endpoints)
    # nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"

    # Authentication (for specific paths)
    # nginx.ingress.kubernetes.io/auth-type: basic
    # nginx.ingress.kubernetes.io/auth-secret: admin-auth
    # nginx.ingress.kubernetes.io/auth-realm: "Authentication Required"

spec:
  tls:
  - hosts:
    - api.gogidix.com
    - admin.gogidix.com
    - app.gogidix.com
    secretName: gogidix-tls-secret
  rules:
  # API Gateway
  - host: api.gogidix.com
    http:
      paths:
      - path: /api(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: api-gateway
            port:
              number: 8080
      # Health Check
      - path: /health(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: api-gateway
            port:
              number: 8080
      # Service-specific routes
      - path: /billing(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: billing-invoicing-service
            port:
              number: 8084
      - path: /users(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: user-management-service
            port:
              number: 8081
      - path: /properties(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: property-management-service
            port:
              number: 8082
      - path: /bookings(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: booking-service
            port:
              number: 8083
      - path: /notifications(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: notification-service
            port:
              number: 8085

  # Admin Dashboard
  - host: admin.gogidix.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: admin-dashboard
            port:
              number: 3000
      - path: /api(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: api-gateway
            port:
              number: 8080

  # Frontend Application
  - host: app.gogidix.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-app
            port:
              number: 3000
      - path: /assets(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: frontend-app
            port:
              number: 3000
---
# Internal API Ingress for Service-to-Service Communication
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: gogidix-internal-ingress
  namespace: gogidix-prod
  annotations:
    kubernetes.io/ingress.class: "nginx-internal"
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  rules:
  - host: gogidix-internal.local
    http:
      paths:
      - path: /billing(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: billing-invoicing-service
            port:
              number: 8084
      - path: /users(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: user-management-service
            port:
              number: 8081
      - path: /properties(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: property-management-service
            port:
              number: 8082
      - path: /config(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: config-server
            port:
              number: 8888
      - path: /registry(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: service-registry
            port:
              number: 8761
---
# Staging Environment Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: gogidix-staging-ingress
  namespace: gogidix-staging
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-staging"
    nginx.ingress.kubernetes.io/rate-limit: "50"
spec:
  tls:
  - hosts:
    - staging-api.gogidix.com
    secretName: gogidix-staging-tls-secret
  rules:
  - host: staging-api.gogidix.com
    http:
      paths:
      - path: /api(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: api-gateway
            port:
              number: 8080
---
# Monitoring Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: gogidix-monitoring-ingress
  namespace: gogidix-monitoring
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/auth-type: "basic"
    nginx.ingress.kubernetes.io/auth-secret: "monitoring-auth"
    nginx.ingress.kubernetes.io/auth-realm: "Gogidix Monitoring"
spec:
  tls:
  - hosts:
    - monitoring.gogidix.com
    secretName: gogidix-monitoring-tls-secret
  rules:
  - host: monitoring.gogidix.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: grafana
            port:
              number: 3000
      - path: /prometheus(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: prometheus
            port:
              number: 9090
      - path: /jaeger(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: jaeger
            port:
              number: 16686