# NVIDIA GPU Device Plugin
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: nvidia-device-plugin-daemonset
  namespace: gpu-operator
  labels:
    app.kubernetes.io/name: nvidia-device-plugin
    app.kubernetes.io/component: nvidia-device-plugin
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: nvidia-device-plugin
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: nvidia-device-plugin
        app.kubernetes.io/component: nvidia-device-plugin
    spec:
      serviceAccount: gpu-operator
      priorityClassName: system-node-critical
      tolerations:
      - key: nvidia.com/gpu
        operator: Exists
        effect: NoSchedule
      - key: nvidia.com/gpu
        operator: Exists
        effect: NoExecute
      # Allow scheduling on control-plane nodes
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
      # Tolerate all taints
      - operator: Exists
      containers:
      - image: nvidia/k8s-device-plugin:v0.14.0
        name: nvidia-device-plugin-ctr
        args:
        - --fail-on-init-error=false
        - --device-list-strategy=envvar
        env:
        - name: FAIL_ON_INIT_ERROR
          value: "false"
        - name: NVIDIA_VISIBLE_DEVICES
          value: "all"
        - name: NVIDIA_MIG_CONFIG_DEVICES
          value: "all"
        - name: NVIDIA_MIG_MONITOR_DEVICES
          value: "all"
        - name: NVIDIA_DRIVER_CAPABILITIES
          value: "compute,utility"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
        volumeMounts:
        - name: device-plugin
          mountPath: /var/lib/kubelet/device-plugins
        - name: root
          mountPath: /root-drv
        - name: ddp
          mountPath: /run/nvidia/dp
        - name: mig-manager
          mountPath: /run/nvidia/mig
        resources:
          limits:
            cpu: "200m"
            memory: "200Mi"
      volumes:
      - name: device-plugin
        hostPath:
          path: /var/lib/kubelet/device-plugins
      - name: root
        hostPath:
          path: /
      - name: ddp
        hostPath:
          path: /run/nvidia/dp
      - name: mig-manager
        hostPath:
          path: /run/nvidia/mig
      nodeSelector:
        accelerator: nvidia-gpu
---
# NVIDIA GPU Device Plugin ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: nvidia-device-plugin-config
  namespace: gpu-operator
data:
  config.json: |
    {
      "version": "v1",
      "flags": {
        "migStrategy": "single",
        "failOnInitError": false,
        "deviceListStrategy": "envvar",
        "nvidiaDriverRoot": "/",
        "gdsEnabled": true,
        "mofedEnabled": true
      },
      "resourceTemplates": [
        {
          "pattern": "nvidia.com/gpu"
        },
        {
          "pattern": "nvidia.com/mig-*"
        }
      ]
    }